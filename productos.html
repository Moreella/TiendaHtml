<!-- producto.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detalle de Producto | Huerto Hogar</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <!-- Tus estilos -->
  <link rel="stylesheet" href="css/header.css" />
  <style>
    .detalle-producto { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .detalle-producto img { width: 100%; height: auto; border-radius: 8px; object-fit: cover; }
    @media (max-width: 768px) { .detalle-producto { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <!-- Header (claro, igual a productos.html) -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light" aria-label="Barra de navegación principal">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">Huerto Hogar</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Abrir menú">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="nosotros.html">Nosotros</a></li>
            <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
            <li class="nav-item"><a class="nav-link" href="productos.html">Tienda</a></li>
            <li class="nav-item"><a class="nav-link" href="contacto.html">Contacto</a></li>
            <li class="nav-item"><a class="nav-link" href="login.html">Cuenta</a></li>
          </ul>
        </div>
      </div>
    </nav>
  </header>

  <!-- Contenido -->
  <main class="container my-4">
    <div id="detalle" class="detalle-producto"></div>
  </main>

  <footer class="py-4 bg-light mt-5">
    <div class="container">
      <small class="text-muted">&copy; 2025 Huerto Hogar — Todos los derechos reservados.</small>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lógica de detalle (con fallbacks) -->
  <script type="module">
    // Intentar usar tus módulos reales
    let storage = null;
    let cart = null;
    try { storage = await import('./js/storage.js'); } catch (e) { console.warn('Sin storage.js, uso fallback.', e); }
    try { cart = await import('./js/cart.js'); } catch (e) { console.warn('Sin cart.js, uso fallback.', e); }

    // Fallbacks
    function fallbackGetProductos() {
      try {
        const raw = localStorage.getItem('app_productos');
        if (raw) return JSON.parse(raw);
      } catch {}
      return []; // si no hay datos, no rompe
    }
    function fallbackAddToCart(codigo, qty) {
      const KEY = 'app_cart';
      const raw = localStorage.getItem(KEY);
      const items = raw ? JSON.parse(raw) : [];
      const i = items.findIndex(x => x.codigo === codigo);
      if (i >= 0) items[i].qty += qty; else items.push({ codigo, qty });
      localStorage.setItem(KEY, JSON.stringify(items));
    }

    // Helpers
    const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    const params = new URLSearchParams(location.search);
    const codigo = params.get('codigo');
    const cont = document.getElementById('detalle');

    // Cargar producto
    let productos = storage?.getProductos ? storage.getProductos() : fallbackGetProductos();
    const p = productos.find(x => x.codigo === codigo);

    if (!p) {
      cont.innerHTML = `
        <div>
          <p class="text-danger">Producto no encontrado.</p>
          <a class="btn btn-outline-secondary" href="productos.html">⬅ Volver a la tienda</a>
        </div>
      `;
    } else {
      cont.innerHTML = `
        <div>
          <img src="${p.imagen || 'img/placeholder.png'}" alt="${p.nombre}">
        </div>
        <div>
          <h1 class="h3">${p.nombre}</h1>
          <p class="fw-semibold text-success fs-5">${fmt.format(Number(p.precio) || 0)}</p>
          <p>${p.descripcion || ''}</p>

          <div class="d-flex align-items-center gap-2 mt-3">
            <label for="qty" class="form-label mb-0">Cantidad:</label>
            <input id="qty" type="number" min="1" step="1" value="1" class="form-control" style="max-width:120px">
            ${Number.isFinite(p.stock) ? `<small class="text-muted">Stock: ${p.stock}</small>` : ''}
          </div>

          <div class="d-flex gap-2 mt-3">
            <button id="btnAdd" class="btn btn-primary">Añadir al carrito</button>
            <a class="btn btn-outline-secondary" href="productos.html">⬅ Volver</a>
          </div>
        </div>
      `;

      // Añadir al carrito
      document.getElementById('btnAdd').addEventListener('click', () => {
        let qty = parseInt(document.getElementById('qty').value, 10);
        if (!Number.isInteger(qty) || qty < 1) qty = 1;

        // respetar stock si existe
        if (Number.isFinite(p.stock) && qty > p.stock) {
          qty = p.stock;
          document.getElementById('qty').value = p.stock;
          alert('Has alcanzado el stock disponible.');
        }

        if (cart?.addToCart) cart.addToCart(codigo, qty);
        else fallbackAddToCart(codigo, qty);

        alert('Producto añadido al carrito ✅');
      });
    }
  </script>
</body>
</html>
